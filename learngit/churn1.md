---
title: churn
description: 本文基于魔豆平台，对用户流失数据进行了可视化,找出影响用户流失的重要因素，进行用户流失的预测，最后提出挽留用户的建议。
thumbnail: 
tags: [docs]
---

# 某电信公司用户流失预测

## 项目背景

### 背景

&emsp;&emsp;用户流失是指用户停止与公司或服务开展业务。用户流失是所有与消费者挂钩行业都会关注的点。因为发展一个新用户是需要一定成本的，一旦用户流失，除了浪费拉新成本，还需要花费更多的用户召回成本。然而，如果一家公司能够预测哪些用户可能提前离开，那么它可以将用户保留工作的重点放在这些“高风险”用户身上。通过解决用户流失问题，这些企业可以发展壮大，获得更多的用户忠诚度。在市场上取得成功。
&emsp;&emsp;所以，在电信行业竞争日益激烈当下，电信运营商需要解决增加用户黏性，延长用户生命周期的问题，这就要求要了解流失用户的特征，分析流失原因，预测流失用户，确定挽留目标用户并制定有效方案。

### 数据来源

来自kaggle平台：<https://www.kaggle.com/blastchar/telco-customer-churn>

## 目标

本文使用魔豆平台完成以下目标：

1. 分析用户特征与流失的关系。
2. 尝试找到合适的模型预测流失用户查看预测效果。
3. 给出增加用户黏性、预防流失的建议。

## 数据集描述

&emsp;&emsp;数据集有21个特征，7043个数据点。
&emsp;&emsp;首先从Table Loader节点导入telcocustomerchurn数据。节点中Input页面Data Source表示选择数据源，Table：选择数据表，Using partiton column:选择是否列分区，Add filter:添加筛选条件，Process页面Output 定义输出数据集名称，Load strategy加载策略，Full load表示全部载入，Incremental load 表示增量载入，过程如下图:
![](1.png)
![](2.png)
![](3.png)

特征具体含义如下表：
|序号 | 数据类型 | 字段表述|
|---| --- | --- |
|customerID|String| 客户ID
|gender |String |客户是男性还是女性|
|SeniorCitizen |Integer| 客户是否为老年人(1,0)|
|Partner |String| 客户是否结婚(是，否)|
|Dependents |String| 客户是否经济独立(是，否)|
|tenure |Integer| 客户在公司停留的月数|
|PhoneService |String| 客户是否有电话服务(是，否)|
|MultipleLines |String| 客户是否有多条线路(是，否，没有电话服务)|
|InternetService |String| 客户的互联网服务提供商(DSL，光纤，否)|
|OnlineSecurity |String| 客户是否在线安全性(是，否,没有互联网服务|)
|OnlineBackup |String| 客户是否有在线备份(是，否,没有互联网服务)|
|DeviceProtection |String| 客户是否有设备保护(是，否，没有互联网服务)|
|TechSupport |String |客户是否有技术支待(是，否，没有互联网服务)|
|StreamingTV |String| 客户是否有流媒体电视(是，否，没有互联网服务)|
|StreamingMovies| String| 客户是否有流媒体电影(是，否，没有互联网服务)|
|Contract |String |客户的合同期限(每月，一年，两年)
|PaperlessBiling |String |客户是否有无纸化联单(是，否)|
|PaymentMethod |String |客户的付款方式(电子支票，邮寄支票，银行转账(自动)，信用卡(自动)〕|
|MonthlyCharges|Integer|每月向客户收取的金额|
|ToalCharges|Integer| 向客户收取的总金额|
|Churn |String| 客户是否流失(是或否)|
要预测的是用户流失与否，流失的定义是在上个月内已经离开，不再续订的客户称为“流失客户”。
特征包含三方面的信息：①有关客户的个人身份信息：性别、年龄以及他们是否有伴侣，是否经济独立。②每个客户注册的服务信息：有无电话服务、多线、互联网、在线安全性、在线备份、设备保护、技术支持以及流媒体电视和电影。③客户合同信息：他们成为客户的时间、合同、付款方式、无纸账单、月付费额和总费用。

## 三、summary
&emsp;&emsp;导入数据后，在python节点summary获取数据集概况
![](4.png)
Process中的Script:输入代码
![](5.png)

&emsp;&emsp;运行后结果如下，result中可以查看数据和进行可视化，history可以查看该节点过去保存的代码。
![](6.png)
![](7.png)
&emsp;&emsp;可以看到，summary节点实现了pandans库中info()和describe()函数的功能，查看了数值型变量的个数、标准差和分位数等，另外还可以显示独特值个数，对于字符型变量则是展示了个数，缺失值比例、数据类型和独特值个数，发现TotalCharages有11个缺失值。
## 四、数据预处理
### 4.1缺失值处理
&emsp;&emsp;TotalCharages有11个缺失值，因为totalCharges 等于tenure * MonthlyCharges ，当在网月数tenure 等于0时，结果就会是NAN，表示为缺失值。tenure为0的十一个数据，Churn都为No，代表的是新用户，并未流失。新用户的数据对于流失预测模型而言，并没有太大参考价值，且数量较少，故直接删除。
### 4.2去除异常值和重复值
观察分位数，认为三个连续变量有没有异常值。数据无重复值。
## 五、用户属性分析
![](8.png)

### 5.1 绘图提示
&emsp;&emsp;目前魔豆网站里还未导入matplotlib和seaborn等绘图库，所以无法使用，否则会报错如下：ModuleNotFoundError: No module named 'matplotlib'。可视化工作主要由Aggregate节点show data里的Visualization完成。
  
    注意：在绘图时也可在其他节点show data的Visualization中直接绘图，但是这样使用Aggregate时只能对前端显示的结果进行Aggregate（1000条以内），所以一般建议使用Aggregate节点进行聚合再绘图。
### 5.2 导入数据
使用sql节点，重命名为用户属性
Output:设置输出数据集名称，Edit:输入代码
![](9.png)
![](10.png)
### 5.3绘图
#### 5.3.1 流失比例
绘制饼图,查看流失客户占比。
![](11.png)

&emsp;&emsp;使用aggregate节点，双击重命名为流失比例扇形图，点开process，其中Output:设置输出数据集名称，Group by columns:选择分组依据的列，Add aggregation functions:选择聚合的方式及列，Suffix:设置输出列的前缀。默认情况下会对多个特征计算count，sum，avg等，但本扇形图不用，只需要对churn进行Group by和count即可，然后点击保存，再运行。
默认情况：
![](12.png)
![](13.png)

&emsp;&emsp;运行后点开show data，可以看到data中展示了节点运行结果。
![](14.png)

&emsp;&emsp;点击Visualization，在右上角点击设置按钮，进入setup界面，在chart type中有多个选项，选择pie，label选择churn，Value选择 churn_count，最后点击apply即可完成初步作图。
![](15.png)

&emsp;&emsp;点击customize，Titles可添加图标题并选择标题位置，Pie下的Pie slice label可以选择使用比例、数量或者两者都显示，本图只使用比例。
![](16.png)
![](17.png)
![](18.png)
可见用户流失情况严重，流失客户样本占比26.6%，留存客户样本占比73.4%，样本轻度不均衡。
Visualization中还可选择把图片保存到某个Dashboard中，方便统一查看图片。
![](19.png)

#### 5.3.2 用户年龄
使用aggregate节点，按churn和seniorcitizen进行分组，也只需对这两个特征进行计数，保存后运行。
运行之后点开show data，打开Visualization点击右上角进入setup，本次Chart type:选择柱状图。其中X-axis:选择x轴对应的列，Aggregate:对绘制的数据进行聚合，Series:选择绘制数据列，Dual Series:选择添加另一列数据，用另一y坐标显示。
点击customize，Titles可添加图标题并选择标题位置、x轴名称和y轴名称，Y-axis:设置y轴范围，Legend:可设置图例文字、位置和颜色。
![](20.png)
![](21.png)
![](22.png)
![](23.png)
![](24.png)
![](25.png)
![](26.png)
结果如下：
![](27.png)

可以看出老年人群体总数较少，但是流失比例较大。
#### 5.3.3 用户性别
用类似的方式进行用户性别与流失关系的柱状图绘制，churn和gender进行分组和计数，保存后，运行节点，绘图过程同用户年龄柱状图过程，故后面不再赘述。
![](28.png)
![](29.png)

结果：
![](30.png)
可以看到男女用户数量接近，流失比例也接近，性别与流失关系不大。
#### 5.3.4 用户婚姻状况
&emsp;&emsp;用类似的方式进行用户性别与流失关系的柱状图绘制，在aggregate节点对churn和gender进行分组和计数，保存后，运行节点，在Visualization中绘图。
![](31.png)
![](32.png)
结果：
![](33.png)
可见未婚用户和已婚用户二者总体数量差距不大，未婚用户流失率略高于已婚用户。
#### 5.3.5 用户经济情况
&emsp;&emsp;用类似的方式进行用户性别与流失关系的柱状图绘制，在aggregate节点对churn和dependents进行分组和计数，保存后，运行节点，在Visualization中绘图。
![](34.png)
结果：
![](35.png)
经济能力未独立的用户流失率高于经济能力独立用户，推测与用户需要控制开支有关。

## 六、合同属性分析
![](36.png)
### 6.1 导入数据
使用sql节点，重命名为合同属性。Output:设置输出数据集名称，Edit：:输入代码。运行后结果如下
![](37.png)
![](38.png)
### 6.2绘图
![](39.png)
#### 6.2.1付费情况
使用aggregate节点，进行用户付费情况与流失关系的柱状图绘制，对churn进行分组，对数值型变量进行计数和平均，保存后，运行节点。
![](40.png)
![](41.png)
选择柱状图，X-axis使用churn，点击dual series，使用平均月消费和总消费绘制符合柱状图，添加图标题和x，y轴标题。
![](42.png)
![](43.png)
![](44.png)
可见流失用户平均总消费更多，但平均月消费却比流失用户还稍少，说明部分消费较多用户流失了。
#### 6.2.2使用月数
过程完全与上图类似，故不再赘述。
![](45.png)
可以看到流失用户使用时长明显低于未流失用户，即老用户不易流失.
#### 6.2.3付费方式
使用aggregate节点，进行用户付费方式与流失关系的柱状图绘制，对churn和paymentmethod进行分组，对数值型变量进行计数和平均，保存后，运行节点。
![](46.png)
![](47.png)
选择柱状图，X-axis使用paymentmethod，使用tenure__count的max和MonthlyCharges_count的min绘制柱状图，添加图标题和x，y轴标题。
![](48.png)
![](49.png)
![](50.png)
电子支付（Electronic cherk）的支付方式明显更容易流失客户，其余方式差别不大，也许时因为办理业务方便，因此去留比较随性。
#### 6.2.4合同时长
过程完全与上图类似，故不再赘述。
![](51.png)
可见签订一个月合同的用户流失率最高，订的合同时长越长，用户越不易流失，推测与合同时长较长用户放弃使用的成本较高。
## 七、服务属性
![](52.png)
### 7.1 导入数据
使用sql节点，重命名为合同属性。Output:设置输出数据集名称，Edit：:输入代码。运行后结果如下
![](53.png)
![](54.png)
### 7.2绘图
柱状图绘图方式完全和之前所述相同，故不再重复展示。
结果如下：
![](55.png)
![](56.png)
![](57.png)
可以看出手机服务指标PhoneService、线路服务MultiLines似乎影响不大，互联网服务中，采用Fiber optic服务的用户更容易流失。
## 八、特征工程
### 8.1特征选择
特征中的用户ID认为对预测无效，直接删除。代码：data=data.drop("customerID", axis=1)
### 8.2特征编码
由于离散特征都是分类变量，所以生成哑变量，这一步魔豆的模型节点会自动进行，不用另外写。
## 九、建模预测
![](58.png)
### 9.1 划分训练集和测试集
使用 Split Train-Test 节点进行划分测试集和训练集，训练集比例默认为0.75。
![](59.png)  
![](60.png)
### 9.2 建模预测
使用GBDT和随机森林分类节点为例，节点中会自动尝试一些参数的网格搜索寻优，然后输出不同阈值下的f1值、全部特征重要性排序，roc和auprc值以及roc曲线作图所需的fpr和tpr值，prc曲线作图所需的精度和召回率。
随机森林结果如下：
![](61.png)
预测结果如下：
特征重要性排名：
![](62.png)
f1值：
![](63.png)
auroc和auprc
![](64.png)
精确率对应召回率：
![](65.png)
fpr和tpr：
![](66.png)
### 9.3模型对比
#### 9.3.1预测效果：

|   |auc|precision|
|--|--|--|
|GBDT |0.845 |0.679|
|RFC |0.840 |0.678|
#### 9.3.2 ROC曲线：
![](67.png)
![](68.png)
#### 9.3.3特征重要性排名：
随机森林输出的重要性前五的特征是：使用时长、合同期限、总消费金额、在线安全性和技术支持。
GBDT输出的重要性前五的特征是：使用时长、在线安全性、付款方式、技术支持和合同期限。
可以看出结果比较相近。
## 十、总结
  本文使用魔豆平台对电信用户流失数据进行了分析，最后使用随机森林和GBDT模型进行了二分类预测，都取得了不错的分类效果，总流程如下：
![](69.png)
### 10.1结论：
流失用户特征：
用户属性：老年用户，未婚用户、经济未独立的用户更容易流失。
合同属性：新用户、签订的合同期较短和使用电子支付的客户容易流失。
服务属性：互联网服务中，采用Fiber optic服务的用户更容易流失。
### 10.2建议：
合同签约时长较短的用户也容易流失，尤其是选择一个月的用户，可以给较长的合同一定优惠，使得用户签订时长变长，增加流失的成本。
月缴费额和开通服务功能直接相关，相对于没有开通服务的用户，开通享受多种附加增值服务的用户相对稳定，促使开通相关服务，可提高客户留存度。
电子支付方式以及互联网服务中的Fiber optic服务需要优化用户体验，或引导用户使用其他支付方式和互联网服务，以减少客户流失。
